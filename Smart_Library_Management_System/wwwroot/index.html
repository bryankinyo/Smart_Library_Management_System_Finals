<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smart Library — Dashboard</title>

    <!-- Bootstrap 5 Dark Mode CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }

        a, a:hover {
            color: inherit;
            text-decoration: none;
        }

        #sidebar {
            min-width: 250px;
            max-width: 250px;
            background-color: #1f1f1f;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 4rem;
            overflow-y: auto;
        }

            #sidebar .nav-link.active {
                background-color: #343a40;
                border-radius: 0.375rem;
            }

        #topbar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 60px;
            background-color: #1f1f1f;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 1rem;
            z-index: 1030;
            border-bottom: 1px solid #343a40;
        }

        main {
            margin-left: 250px;
            margin-top: 60px;
            padding: 1.5rem;
        }

        .card {
            background-color: #1f1f1f;
            border: 1px solid #343a40;
        }

            .card .card-title, .card .card-text {
                color: #e0e0e0;
            }

        .btn {
            color: #e0e0e0;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

            .btn-primary:hover {
                background-color: #0069d9;
            }

        .form-control {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #343a40;
        }

            .form-control:focus {
                background-color: #2a2a2a;
                color: #e0e0e0;
                border-color: #007bff;
                box-shadow: 0 0 0 0.25rem rgba(0,123,255,.25);
            }

        .form-label {
            color: #e0e0e0;
        }

        select[multiple] {
            height: 150px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #343a40;
        }

        ul.list-group li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar" class="d-flex flex-column">
        <div class="text-center mb-3"><h4>📚 Smart Library</h4></div>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item"><a class="nav-link active" href="#" data-target="dashboard"><i class="fas fa-home me-2"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="books"><i class="fas fa-book me-2"></i> Books</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="users"><i class="fas fa-user me-2"></i> Users</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="loans"><i class="fas fa-hand-holding me-2"></i> Loans</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="reservations"><i class="fas fa-calendar-check me-2"></i> Reservations</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="fines"><i class="fas fa-money-bill-wave me-2"></i> Fines</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-target="catalogs"><i class="fas fa-list-alt me-2"></i> Catalogs</a></li>
        </ul>
    </nav>

    <!-- Topbar -->
    <div id="topbar">
        <input class="form-control me-2" type="text" placeholder="Search..." id="globalSearch" style="width:300px;">
        <button class="btn btn-primary" id="btnSearch">Search</button>
    </div>

    <!-- Main content -->
    <main id="content">
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-book me-2"></i> Total Books</h5>
                        <p class="card-text" id="totalBooks">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-user me-2"></i> Total Users</h5>
                        <p class="card-text" id="totalUsers">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-hand-holding me-2"></i> Active Loans</h5>
                        <p class="card-text" id="activeLoans">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-money-bill-wave me-2"></i> Total Fines</h5>
                        <p class="card-text" id="totalFines">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="pageContent">
            <h2>Welcome to Smart Library Dashboard</h2>
            <p>Select a section from the sidebar to manage books, users, loans, reservations, fines, and catalogs.</p>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "https://localhost:7088/api";

        // Function to generate input fields
        function createInput(label, type = "text", id = "", placeholder = "") {
            return `<div class="mb-3">
                                <label class="form-label" for="${id}">${label}</label>
                                <input type="${type}" class="form-control" id="${id}" placeholder="${placeholder}">
                            </div>`;
        }

        function createSelect(label, id, options = [], multiple = false) {
            let multipleAttr = multiple ? "multiple" : "";
            let html = `<div class="mb-3">
                                    <label class="form-label" for="${id}">${label}</label>
                                    <select class="form-control" id="${id}" ${multipleAttr}>
                                        <option value="">Select...</option>`;
            options.forEach(opt => {
                html += `<option value="${opt.value}">${opt.text}</option>`;
            });
            html += `</select></div>`;
            return html;
        }

        // Load dashboard cards
        async function loadDashboard() {
            try {
                const [books, users, loans, fines] = await Promise.all([
                    fetch(`${API_BASE}/books`).then(r => r.json()),
                    fetch(`${API_BASE}/users`).then(r => r.json()),
                    fetch(`${API_BASE}/loans`).then(r => r.json()),
                    fetch(`${API_BASE}/fines`).then(r => r.json()),
                ]);
                document.getElementById("totalBooks").textContent = books.length;
                document.getElementById("totalUsers").textContent = users.length;
                document.getElementById("activeLoans").textContent = loans.filter(l => !l.returnedAt).length;
                document.getElementById("totalFines").textContent = `$${fines.reduce((sum, f) => sum + f.amount, 0)}`;
            } catch (err) {
                console.error("Dashboard load failed:", err);
            }
        }

        // Load sections with forms and list
        async function loadSection(endpoint, title) {
            try {
                let html = `<h3>${title}</h3>`;
                let books = [], users = [];
                if (["loans", "reservations", "catalogs"].includes(endpoint)) {
                    books = await fetch(`${API_BASE}/books`).then(r => r.json());
                }
                if (["loans", "reservations", "fines"].includes(endpoint)) {
                    users = await fetch(`${API_BASE}/users`).then(r => r.json());
                }

                // Forms for each section
                switch (endpoint) {
                    case "books":
                        html += `<h5>Add Book</h5>
                                <form id="formBook">
                                    ${createInput("Title", "text", "bookTitle", "Book Title")}
                                    ${createInput("Author", "text", "bookAuthor", "Author")}
                                    ${createInput("ISBN", "text", "bookISBN", "ISBN")}
                                    ${createInput("Published Year", "number", "bookYear", "e.g. 2023")}
                                    <button class="btn btn-primary" type="submit">Add Book</button>
                                </form><hr><div id="booksList"></div>`;
                        break;
                    case "users":
                        html += `<h5>Add User</h5>
                                <form id="formUser">
                                    ${createInput("Name", "text", "userName", "Full Name")}
                                    ${createInput("Email", "email", "userEmail", "Email")}
                                    <div class="mb-3">
                                        <label class="form-label" for="userRole">Role</label>
                                        <select class="form-control" id="userRole">
                                            <option value="">Select role...</option>
                                            <option value="Student">Student</option>
                                            <option value="Faculty">Faculty</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" type="submit">Add User</button>
                                </form><hr><div id="usersList"></div>`;
                        break;
                    case "loans":
                        html += `<h5>Add Loan</h5>
                                <form id="formLoan">
                                    ${createSelect("Book", "loanBook", books.map(b => ({ value: b.id, text: b.title })))}
                                    ${createSelect("User", "loanUser", users.map(u => ({ value: u.id, text: u.name })))}
                                    ${createInput("Due Date", "date", "loanDue", "")}
                                    <button class="btn btn-primary" type="submit">Add Loan</button>
                                </form><hr><div id="loansList"></div>`;
                        break;
                    case "reservations":
                        html += `<h5>Add Reservation</h5>
                                <form id="formReservation">
                                    ${createSelect("Book", "reservationBook", books.map(b => ({ value: b.id, text: b.title })))}
                                    ${createSelect("User", "reservationUser", users.map(u => ({ value: u.id, text: u.name })))}
                                    ${createInput("Reservation Date", "date", "reservationDate", "")}
                                    <button class="btn btn-primary" type="submit">Add Reservation</button>
                                </form><hr><div id="reservationsList"></div>`;
                        break;
                    case "fines":
                        html += `<h5>Add Fine</h5>
                                <form id="formFine">
                                    ${createSelect("User", "fineUser", users.map(u => ({ value: u.id, text: u.name })))}
                                    ${createInput("Amount", "number", "fineAmount", "")}
                                    ${createInput("Reason", "text", "fineReason", "")}
                                    <div class="mb-3">
                                        <label class="form-label" for="finePaid">Paid</label>
                                        <select class="form-control" id="finePaid">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" type="submit">Add Fine</button>
                                </form><hr><div id="finesList"></div>`;
                        break;
                    case "catalogs":
                        html += `<h5>Add Catalog</h5>
                                <form id="formCatalog">
                                    ${createInput("Catalog Name", "text", "catalogName", "Name")}
                                    ${createSelect("Books (multiple)", "catalogBooks", books.map(b => ({ value: b.id, text: b.title })), true)}
                                    <button class="btn btn-primary" type="submit">Add Catalog</button>
                                </form><hr><div id="catalogsList"></div>`;
                        break;
                }

                document.getElementById("pageContent").innerHTML = html;
                attachFormHandlers(endpoint);
                loadList(endpoint);
            } catch (err) {
                console.error(`Load section ${title} failed:`, err);
            }
        }

        function attachFormHandlers(endpoint) {
            const postJSON = async (url, payload) => await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (endpoint === "books") document.getElementById("formBook")?.addEventListener("submit", async e => {
                e.preventDefault();
                const payload = {
                    title: document.getElementById("bookTitle").value,
                    author: document.getElementById("bookAuthor").value,
                    isbn: document.getElementById("bookISBN").value,
                    publishedYear: parseInt(document.getElementById("bookYear").value)
                };
                await postJSON(`${API_BASE}/books`, payload);
                loadSection("books", "Books");
            });

            if (endpoint === "users") document.getElementById("formUser")?.addEventListener("submit", async e => {
                e.preventDefault();
                const payload = {
                    name: document.getElementById("userName").value,
                    email: document.getElementById("userEmail").value,
                    role: document.getElementById("userRole").value
                };
                await postJSON(`${API_BASE}/users`, payload);
                loadSection("users", "Users");
            });

            if (endpoint === "loans") document.getElementById("formLoan")?.addEventListener("submit", async e => {
                e.preventDefault();
                const payload = {
                    bookId: document.getElementById("loanBook").value,
                    userId: document.getElementById("loanUser").value,
                    dueAt: document.getElementById("loanDue").value
                };
                await postJSON(`${API_BASE}/loans`, payload);
                loadSection("loans", "Loans");
            });

            if (endpoint === "reservations") document.getElementById("formReservation")?.addEventListener("submit", async e => {
                e.preventDefault();
                const payload = {
                    bookId: document.getElementById("reservationBook").value,
                    userId: document.getElementById("reservationUser").value,
                    reservationDate: document.getElementById("reservationDate").value
                };
                await postJSON(`${API_BASE}/reservations`, payload);
                loadSection("reservations", "Reservations");
            });

            if (endpoint === "fines") document.getElementById("formFine")?.addEventListener("submit", async e => {
                e.preventDefault();
                const payload = {
                    userId: document.getElementById("fineUser").value,
                    amount: parseFloat(document.getElementById("fineAmount").value),
                    reason: document.getElementById("fineReason").value,
                    paid: document.getElementById("finePaid").value === "true"
                };
                await postJSON(`${API_BASE}/fines`, payload);
                loadSection("fines", "Fines");
            });

            if (endpoint === "catalogs") document.getElementById("formCatalog")?.addEventListener("submit", async e => {
                e.preventDefault();
                const selectedBooks = [...document.getElementById("catalogBooks").selectedOptions].map(o => o.value);
                const payload = {
                    name: document.getElementById("catalogName").value,
                    bookIds: selectedBooks
                };
                await postJSON(`${API_BASE}/catalogs`, payload);
                loadSection("catalogs", "Catalogs");
            });
        }

        async function loadList(endpoint) {
            try {
                const data = await fetch(`${API_BASE}/${endpoint}`).then(r => r.json());
                let htmlList = "<ul class='list-group'>";
                data.forEach(item => {
                    htmlList += `<li class='list-group-item bg-dark text-light'>${JSON.stringify(item)}</li>`;
                });
                htmlList += "</ul>";
                const listId = {
                    books: "booksList",
                    users: "usersList",
                    loans: "loansList",
                    reservations: "reservationsList",
                    fines: "finesList",
                    catalogs: "catalogsList"
                }[endpoint];
                if (listId) document.getElementById(listId).innerHTML = htmlList;
            } catch (err) { console.error(`Load list ${endpoint} failed:`, err); }
        }

        // Navigation clicks
        document.querySelectorAll("#sidebar .nav-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                document.querySelectorAll("#sidebar .nav-link").forEach(l => l.classList.remove("active"));
                link.classList.add("active");
                const target = link.dataset.target;
                if (target === "dashboard") {
                    loadDashboard();
                    document.getElementById("pageContent").innerHTML = `<h2>Welcome to Smart Library Dashboard</h2><p>Select a section from the sidebar to manage books, users, loans, reservations, fines, and
                        catalogs.</p>`;
                } else {
                    // Load the corresponding section
                    const sectionNames = {
                        books: "Books",
                        users: "Users",
                        loans: "Loans",
                        reservations: "Reservations",
                        fines: "Fines",
                        catalogs: "Catalogs"
                    };
                    loadSection(target, sectionNames[target]);
                }
            });
        });

        // Global Search
        document.getElementById("btnSearch").addEventListener("click", async () => {
            const query = document.getElementById("globalSearch").value.trim().toLowerCase();
            if (!query) return;

            const endpoints = ["books", "users", "loans", "reservations", "fines", "catalogs"];
            let resultsHtml = "<h3>Search Results</h3>";

            for (const endpoint of endpoints) {
                try {
                    const data = await fetch(`${API_BASE}/${endpoint}`).then(r => r.json());
                    const filtered = data.filter(item => JSON.stringify(item).toLowerCase().includes(query));
                    if (filtered.length > 0) {
                        resultsHtml += `<h5>${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}</h5><ul class='list-group mb-3'>`;
                        filtered.forEach(item => {
                            resultsHtml += `<li class='list-group-item bg-dark text-light'>${JSON.stringify(item)}</li>`;
                        });
                        resultsHtml += "</ul>";
                    }
                } catch (err) {
                    console.error(`Search ${endpoint} failed:`, err);
                }
            }

            if (resultsHtml === "<h3>Search Results</h3>") {
                resultsHtml += "<p>No results found.</p>";
            }

            document.getElementById("pageContent").innerHTML = resultsHtml;
        });

        // Initial load
        loadDashboard();
    </script>
</body>
</html>
